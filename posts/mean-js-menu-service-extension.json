{"id":"mean-js-menu-service-extension","title":"MEAN.js Menu Service Extension","date":"2016-01-05T17:34:47.000Z","categories":["JavaScript"],"tags":["AngularJs","MEAN-Stack"],"html":"<p>MEAN.js解决方案只提供了1级/2级菜单栏的service支持，最近项目中需要用到第3级菜单，所以需要进行一个小的功能扩展。一开始我以为可以很容易地做到无限级，真正做起来以后发现并没有那么简单，所以目前通过这个办法只能达到第3级。</p>\n<!--more-->\n<h2 id=\"menu\">修改Menu服务 <a class=\"header-anchor\" href=\"#menu\" aria-hidden=\"true\">&#128279;</a></h2>\n<p>初始的Menu Service中为使用者写了两个添加菜单项的方法：</p>\n<pre><code>// Add menu item object\nthis.addMenuItem = function (menuId, options)\n</code></pre>\n<p>以及</p>\n<pre><code>// Add submenu item object\nthis.addSubMenuItem = function (menuId, parentItemState, options)\n</code></pre>\n<p>第一个方法很显然就是用来添加顶级菜单了，第二个在没有看代码以前我曾经天真地以为它可以无限嵌套，然而并没有，它做的事情仅限于添加第2级菜单。所以现在我需要自己写第三个方法来完成添加第三级菜单。考虑到三级循环的效率问题，虽然一般来说菜单项不会有太多，但看起来就是非常不爽，所以我给每个Menu项都添加了一个哈希表来储存其下面所有菜单项的引用，这样多花费一点点内存就可以不用写循环嵌套了。由于使用了哈希表，对原2级菜单做了一些修改：</p>\n<pre><code>// Add submenu item object\n    this.addSubMenuItem = function (menuId, parentItemState, options) {\n        options = options || {};\n\n        // Validate that the menu exists\n        this.validateMenuExistance(menuId);\n\n        // Search for menu item\n        for (var itemIndex in this.menus[menuId].items) {\n            if (this.menus[menuId].items[itemIndex].state === parentItemState) {\n                // Push new submenu item\n                var newSubmenuItem = {\n                    title: options.title || '',\n                    state: options.state || '',\n                    disabled: options.disabled || false,\n                    roles: ((options.roles === null || typeof options.roles === 'undefined') ? this.menus[menuId].items[itemIndex].roles : options.roles),\n                    position: options.position || 0,\n                    shouldRender: shouldRender,\n                    items: []\n                };\n                this.menus[menuId].items[itemIndex].items.push(newSubmenuItem);\n                this.menus[menuId].menuHash[newSubmenuItem.state] = newSubmenuItem;\n\n                if (options.items) {\n                    for (var i in options.items) {\n                        this.addSubMenuItemToSubMenu(menuId, options.state, options.items[i]);\n                    }\n                }\n            }\n        }\n\n        // Return the menu object\n        return this.menus[menuId];\n    };\n</code></pre>\n<p>然后是新的添加3级菜单的方法：</p>\n<pre><code>//For level 3 menu items\n    this.addSubMenuItemToSubMenu = function (menuId, parentItemState, options) {\n        options = options || {};\n        this.validateMenuExistance(menuId);\n        for (var itemIndex in this.menus[menuId].menuHash) {\n            if (this.menus[menuId].menuHash[itemIndex].state === parentItemState) {\n                // Push new submenu item\n                var newSubMenuItem = {\n                    title: options.title || '',\n                    state: options.state || '',\n                    disabled: options.disabled || false,\n                    roles: ((options.roles === null || typeof options.roles === 'undefined') ? this.menus[menuId].menuHash[itemIndex].roles : options.roles),\n                    position: options.position || 0,\n                    shouldRender: shouldRender,\n                    items: []\n                };\n                this.menus[menuId].menuHash[itemIndex].items.push(newSubMenuItem);\n                this.menus[menuId].menuHash[newSubMenuItem.state] = newSubMenuItem;\n            }\n        }\n        return this.menus[menuId];\n    };\n</code></pre>\n<h2 id=\"header\">修改Header模板 <a class=\"header-anchor\" href=\"#header\" aria-hidden=\"true\">&#128279;</a></h2>\n<p>原Header模板中嵌套了两层Angular循环来遍历菜单项，我们给它加一层就好了，改完以后就像这样：</p>\n<pre><code>&lt;nav class=&quot;collapse navbar-collapse&quot; uib-collapse=&quot;!isCollapsed&quot; role=&quot;navigation&quot;&gt;\n    &lt;ul class=&quot;nav navbar-nav&quot; ng-if=&quot;menu.shouldRender(authentication.user);&quot;&gt;\n      &lt;li ng-repeat=&quot;item in menu.items | orderBy: 'position'&quot; ng-if=&quot;item.shouldRender(authentication.user);&quot;\n          ng-switch=&quot;item.type&quot;\n          ng-class=&quot;{ active: $state.includes(item.state), dropdown: item.type === 'dropdown',disabled:item.disabled }&quot;\n          class=&quot;{{item.class}}&quot; uib-dropdown=&quot;item.type === 'dropdown'&quot;&gt;\n        &lt;a ng-switch-when=&quot;dropdown&quot; class=&quot;dropdown-toggle&quot; uib-dropdown-toggle role=&quot;button&quot;&gt;{{::item.title}}&amp;nbsp;&lt;span\n          class=&quot;caret&quot;&gt;&lt;/span&gt;&lt;/a&gt;\n        &lt;ul ng-switch-when=&quot;dropdown&quot; class=&quot;dropdown-menu&quot;&gt;\n          &lt;li ng-repeat=&quot;subitem in item.items | orderBy: 'position'&quot; ng-if=&quot;subitem.shouldRender(authentication.user);&quot;\n              ui-sref-active=&quot;active&quot; ng-class=&quot;{'dropdown-submenu':subitem.items.length&gt;0,disabled:subitem.disabled}&quot;&gt;\n            &lt;a ui-sref=&quot;{{subitem.state}}&quot; ng-bind=&quot;subitem.title&quot; ng-if=&quot;subitem.items.length===0&quot;&gt;&lt;/a&gt;\n            &lt;a href=&quot;javascript:;&quot; ng-bind=&quot;subitem.title&quot; ng-if=&quot;subitem.items.length&gt;0&quot;&gt;&lt;/a&gt;\n            &lt;ul class=&quot;dropdown-menu&quot; ng-if=&quot;subitem.items.length&gt;0&quot;&gt;\n              &lt;li ng-repeat=&quot;i in subitem.items | orderBy: 'position'&quot; ng-if=&quot;i.shouldRender(authentication.user);&quot;\n                  ui-sref-active=&quot;active&quot; ng-class=&quot;{disabled:i.disabled}&quot;&gt;\n                &lt;a ui-sref=&quot;{{i.state}}&quot; ng-bind=&quot;i.title&quot;&gt;&lt;/a&gt;\n              &lt;/li&gt;\n            &lt;/ul&gt;\n          &lt;/li&gt;\n        &lt;/ul&gt;\n        &lt;a ng-switch-default ui-sref=&quot;{{item.state}}&quot; ng-bind=&quot;item.title&quot;&gt;&lt;/a&gt;\n      &lt;/li&gt;\n    &lt;/ul&gt;\n    &lt;ul class=&quot;nav navbar-nav navbar-right&quot; ng-hide=&quot;authentication.user&quot;&gt;\n      &lt;li ui-sref-active=&quot;active&quot;&gt;\n        &lt;a ui-sref=&quot;authentication.signup&quot;&gt;Sign Up&lt;/a&gt;\n      &lt;/li&gt;\n      &lt;li class=&quot;divider-vertical&quot;&gt;&lt;/li&gt;\n      &lt;li ui-sref-active=&quot;active&quot;&gt;\n        &lt;a ui-sref=&quot;authentication.signin&quot;&gt;Sign In&lt;/a&gt;\n      &lt;/li&gt;\n    &lt;/ul&gt;\n    &lt;ul class=&quot;nav navbar-nav navbar-right&quot; ng-show=&quot;authentication.user&quot;&gt;\n      &lt;li class=&quot;dropdown&quot; uib-dropdown&gt;\n        &lt;a class=&quot;dropdown-toggle user-header-dropdown-toggle&quot; uib-dropdown-toggle role=&quot;button&quot;&gt;\n          &lt;img ng-src=&quot;{{authentication.user.profileImageURL}}&quot; alt=&quot;{{authentication.user.displayName}}&quot;\n               class=&quot;header-profile-image&quot;/&gt;\n          &lt;span ng-bind=&quot;authentication.user.displayName&quot;&gt;&lt;/span&gt; &lt;b class=&quot;caret&quot;&gt;&lt;/b&gt;\n        &lt;/a&gt;\n        &lt;ul class=&quot;dropdown-menu&quot; role=&quot;menu&quot;&gt;\n          &lt;li ui-sref-active=&quot;active&quot;&gt;\n            &lt;a ui-sref=&quot;settings.profile&quot;&gt;Edit Profile&lt;/a&gt;\n          &lt;/li&gt;\n          &lt;li ui-sref-active=&quot;active&quot;&gt;\n            &lt;a ui-sref=&quot;settings.picture&quot;&gt;Change Profile Picture&lt;/a&gt;\n          &lt;/li&gt;\n          &lt;li ui-sref-active=&quot;active&quot; ng-show=&quot;authentication.user.provider === 'local'&quot;&gt;\n            &lt;a ui-sref=&quot;settings.password&quot;&gt;Change Password&lt;/a&gt;\n          &lt;/li&gt;\n          &lt;!--li ui-sref-active=&quot;active&quot;&gt;\n            &lt;a ui-sref=&quot;settings.accounts&quot;&gt;Manage Social Accounts&lt;/a&gt;\n          &lt;/li--&gt;\n          &lt;li class=&quot;divider&quot;&gt;&lt;/li&gt;\n          &lt;li&gt;\n            &lt;a href=&quot;/api/auth/signout&quot; target=&quot;_self&quot;&gt;Signout&lt;/a&gt;\n          &lt;/li&gt;\n        &lt;/ul&gt;\n      &lt;/li&gt;\n    &lt;/ul&gt;\n  &lt;/nav&gt;\n</code></pre>\n<h2 id=\"css\">修改CSS <a class=\"header-anchor\" href=\"#css\" aria-hidden=\"true\">&#128279;</a></h2>\n<p>为了让菜单看起来更自然些，这里修改的是 <code>core.css</code>，添加以下内容：</p>\n<pre><code>.dropdown-submenu {\n    position: relative;\n}\n\n.dropdown-menu {\n    -webkit-border-radius: 0;\n    -moz-border-radius: 0;\n    border-radius: 0;\n}\n\n.dropdown-submenu &gt; .dropdown-menu {\n    top: 0;\n    left: 100%;\n    margin-top: -6px;\n    margin-left: -1px;\n}\n\n.dropdown-submenu:hover &gt; .dropdown-menu {\n    display: block;\n}\n\n.dropdown-submenu &gt; a:after {\n    display: block;\n    content: &quot; &quot;;\n    float: right;\n    width: 0;\n    height: 0;\n    border-color: transparent;\n    border-style: solid;\n    border-width: 5px 0 5px 5px;\n    border-left-color: #333;\n    margin: 5px -10px 0;\n}\n\n.dropdown-submenu:hover &gt; a:after {\n    border-left-color: #333;\n}\n\n.dropdown-submenu.pull-left {\n    float: none;\n}\n\n.dropdown-submenu.pull-left &gt; .dropdown-menu {\n    left: -100%;\n    margin-left: 10px;\n    -webkit-border-radius: 6px 0 6px 6px;\n    -moz-border-radius: 6px 0 6px 6px;\n    border-radius: 6px 0 6px 6px;\n}\n</code></pre>\n<p> </p>\n<h2 id=\"\">使用方法 <a class=\"header-anchor\" href=\"#\" aria-hidden=\"true\">&#128279;</a></h2>\n<p>3级菜单的定义方法与2级菜单一模一样，除了直接调用 <code>addSubMenuItemToSubMenu</code>  以外，还可以通过在2级菜单内定义 <code>items</code> 来实现添加子菜单，示例如下，高亮部分则为3级菜单：</p>\n<pre><code>Menus.addMenuItem('topbar', {\n            title: '...',\n            state: '...',\n            type: 'dropdown',\n            position: 0,\n            roles: ['*'],\n            items: [{\n                title: '...',\n                state: '...',\n                roles: ['*']\n            }, {\n                title: '...',\n                state: '...',\n                roles: ['*'],\n                items: [{\n                    title: '...',\n                    state: '...',\n                    roles: ['*']\n                }, {\n                    title: '...',\n                    state: '...',\n                    roles: ['*']\n                }]\n            }]\n        });\n</code></pre>\n<h2 id=\"-2\">实现无限级 <a class=\"header-anchor\" href=\"#-2\" aria-hidden=\"true\">&#128279;</a></h2>\n<p>目前看来菜单层级的限制不是在于Service代码，而在于模板。如何在模板中让Angular做一个DFS搜索才是重点。Angular貌似没有提供类似的API，要做的话比较好的办法应该是自己写一个指令。以后有时间再来实现。</p>\n"}