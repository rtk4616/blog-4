<!DOCTYPE html><html class="nprogress-busy"><head><meta charset="utf-8"><meta name="google-site-verification" content="ekuL5J7xK1IdFtP13v3KxpuGKnYS1oCT9PvZdjYm8Eg"><meta name="viewport" content="user-scalable=no,width=device-width,initial-scale=1,maximum-scale=1"><link rel="shortcut icon" type="image/png" href="/static/favicon.png"><link rel="apple-touch-icon" sizes="200x200" href="/static/favicon-iphone.png"><title>wxsm's space - CORS Headers Note</title><meta name="description" content="wxsms's personal blog."><meta name="keywords" content="Blog,JavaScript,HTML,CSS,Vue,Bootstrap"><link href="/static/css/app.c460d3b13d6d7ce0c63faa74a9023a8f.css" rel="stylesheet"><script type="text/javascript" src="/static/js/manifest.68263eefe155d055bfa0.js"></script><script type="text/javascript" src="/static/js/vendor.19a2875ac58b9bf76cc9.js"></script><script type="text/javascript" src="/static/js/app.6317672e36f60ab5ad32.js"></script><script async="" src="https://www.google-analytics.com/analytics.js" charset="utf8"></script><script async="" src="https://www.google-analytics.com/analytics.js" charset="utf8"></script><script type="text/javascript" charset="utf-8" async="" src="/static/js/0.24af7fe1e27d3b16bd28.js"></script><script type="text/javascript" charset="utf-8" async="" src="/static/js/4.f6eaab3002dc8add016f.js"></script><script type="text/javascript" charset="utf-8" async="" src="/static/js/0.24af7fe1e27d3b16bd28.js"></script><script type="text/javascript" charset="utf-8" async="" src="/static/js/1.3d038e42bb029d58fb1c.js"></script><script type="text/javascript" async="" id="embed-disqus" data-timestamp="1539144385845" src="//wxsm.disqus.com/embed.js"></script></head><body><section id="app"><section data-v-6a2c05ce="" style="display: none;"></section> <aside data-v-0044a876="" class=""><div data-v-0044a876="" class="brand"><h4 data-v-0044a876="" class="brand-link"><a data-v-0044a876="" href="/" class="router-link-active">wxsm's space</a></h4></div> <div data-v-0044a876="" class="search-container"><form data-v-e01410e2="" data-v-0044a876="" class="form-inline search-form-box"><div data-v-e01410e2="" class="form-group"><input data-v-e01410e2="" type="search" placeholder="Search..." required="required" minlength="2" class="form-control"></div></form></div> <div data-v-0044a876="" class="nav-container"><div data-v-0044a876="" class="nav-div"><ul data-v-0044a876="" role="tablist" class="nav nav-pills nav-stacked"><li data-v-0044a876="" role="presentation"><a data-v-0044a876="" href="/p" class="router-link-active btn btn-link" role="button">Archive</a></li><li data-v-0044a876="" role="presentation"><a data-v-0044a876="" href="/t" class="btn btn-link" role="button">Tags</a></li><li data-v-0044a876="" role="presentation"><a data-v-0044a876="" href="/g" class="btn btn-link" role="button">Guestbook</a></li><li data-v-0044a876="" role="presentation"><a data-v-0044a876="" href="/a" class="btn btn-link" role="button">About</a></li></ul></div> <div data-v-0044a876="" class="toc-div"><ul data-v-d065e12c="" data-v-0044a876="" class="toc-ul"><li data-v-d065e12c=""><a data-v-d065e12c="" href="#"><b data-v-d065e12c="">客户端 </b></a> <ul data-v-d065e12c=""><li data-v-d065e12c=""><a data-v-d065e12c="" href="#-2">请求预检 </a></li><li data-v-d065e12c=""><a data-v-d065e12c="" href="#-3">身份验证 </a></li></ul></li><li data-v-d065e12c=""><a data-v-d065e12c="" href="#-4"><b data-v-d065e12c="">服务端 </b></a> <ul data-v-d065e12c=""><li data-v-d065e12c=""><a data-v-d065e12c="" href="#withcredentials">withCredentials </a></li></ul></li></ul></div></div></aside> <section data-v-79039cdb="" class="page"><div data-v-79039cdb="" class="page-body"><button data-v-01aba251="" data-v-79039cdb="" type="button" class="navbar-toggle collapsed"><span data-v-01aba251="" class="sr-only">Toggle navigation</span> <span data-v-01aba251="" class="icon-bar"></span> <span data-v-01aba251="" class="icon-bar"></span> <span data-v-01aba251="" class="icon-bar"></span></button> <div data-v-79039cdb="" class="container-fluid"><div data-v-79039cdb="" class="row"><div data-v-79039cdb="" class="col-xs-12"><section data-v-f233b600="" data-v-79039cdb=""><h1 data-v-f233b600="">CORS Headers Note</h1> <section data-v-f233b600="" id="post-content"><section data-v-19e352bd="" data-v-f233b600=""><div data-v-19e352bd="" class="meta-block"><i data-v-19e352bd="" class="glyphicon glyphicon-calendar"></i> <span data-v-19e352bd="">October 12, 2017</span></div> <div data-v-19e352bd="" class="meta-block"><a data-v-3cd447cb="" data-v-19e352bd="" href="/t#Ajax" class="label-tag"><span data-v-3cd447cb="" class="label label-default">Ajax</span></a><a data-v-3cd447cb="" data-v-19e352bd="" href="/t#HTTP" class="label-tag"><span data-v-3cd447cb="" class="label label-default">HTTP</span></a><a data-v-3cd447cb="" data-v-19e352bd="" href="/t#NodeJs" class="label-tag"><span data-v-3cd447cb="" class="label label-success">NodeJs</span></a></div></section> <div data-v-f233b600=""><p>CORS HTTP Header 是解决 Ajax 跨域问题的方案之一。详情查看：<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS">MDN</a></p>
<p>这篇文章主要是记录使用过程中遇到的问题以及解决方案。</p>
<!--more-->
<h2 id="">客户端 <a class="header-anchor" href="#" aria-hidden="true">🔗</a></h2>
<p>客户端正常情况无需特殊配置。但有一些需要注意的地方。</p>
<h3 id="-2">请求预检 <a class="header-anchor" href="#-2" aria-hidden="true">🔗</a></h3>
<p>CORS 请求与非跨域请求不一样的是，它会将请求分成两种类型：<strong>Simple Request（简单请求）<strong>与</strong>Preflighted Request（预检请求）</strong>。</p>
<h4 id="simple-request">Simple Request <a class="header-anchor" href="#simple-request" aria-hidden="true">🔗</a></h4>
<p>满足<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS#Simple_requests">所有条件</a>的请求为简单请求。</p>
<p>看了文档以后发现跟普通请求别无二致。</p>
<h4 id="preflighted-request">Preflighted Request <a class="header-anchor" href="#preflighted-request" aria-hidden="true">🔗</a></h4>
<p>满足<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS#Preflighted_requests">任一条件</a>的请求为预检请求。</p>
<p>与简单请求不同，预检请求要求必须首先使用 <code>OPTIONS</code> 方法发起一个预检请求到服务器，以获知服务器是否允许该实际请求，以避免跨域请求对服务器的用户数据产生未预期的影响。</p>
<p><img src="https://mdn.mozillademos.org/files/14289/prelight.png" alt="预检请求示意图"></p>
<p>所以，实际上这种跨域请求会产生两次 HTTP Request：一个预检请求，以及预检成功后的真正的请求。由于预检请求使用 <code>OPTIONS</code> 方法而不是常见的 <code>POST</code> 等，因此服务器必须为跨域 API 提供能够正确返回的相应方法。</p>
<h3 id="-3">身份验证 <a class="header-anchor" href="#-3" aria-hidden="true">🔗</a></h3>
<p>如果需要进行 Cookie / Session / HTTP Authentication 等操作，则必须在进行 Ajax 请求时带上一个 <code>withCredentials</code> 参数。至于如何带这个参数，每个 Lib 应该都有自己的配置方式，下面是两个例子。</p>
<p>Raw Ajax Example:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">var</span> invocation = <span class="hljs-keyword">new</span> XMLHttpRequest();
<span class="hljs-keyword">var</span> url = <span class="hljs-string">'http://bar.other/resources/credentialed-content/'</span>;
    
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">callOtherDomain</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">if</span>(invocation) {
    invocation.open(<span class="hljs-string">'GET'</span>, url, <span class="hljs-literal">true</span>);
    invocation.withCredentials = <span class="hljs-literal">true</span>;
    invocation.onreadystatechange = handler;
    invocation.send(); 
  }
}
</code></pre>
<p>Using Axios Example:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">let</span> corsAgent = axios.create({
  <span class="hljs-attr">withCredentials</span>: <span class="hljs-literal">true</span>
})
</code></pre>
<h2 id="-4">服务端 <a class="header-anchor" href="#-4" aria-hidden="true">🔗</a></h2>
<p>服务端的配置并不是只需要给请求响应加个 <code>Access-Control-Allow-Origin</code> Header 这么简单，还有其它需要处理的地方。因此自己做远不如直接使用相关 Lib 来得方便。比如：</p>
<ul>
<li><a href="https://github.com/expressjs/cors">Express CORS</a></li>
<li><a href="https://github.com/koajs/cors">Koa CORS</a></li>
</ul>
<h3 id="withcredentials">withCredentials <a class="header-anchor" href="#withcredentials" aria-hidden="true">🔗</a></h3>
<p>当启用 <code>withCredentials</code> 参数后，<code>Access-Control-Allow-Origin</code> 将不能设置为 <code>*</code> （允许所有域名），必须指定为唯一的域名，否则预期的效果将无法达到。由于这个规则不会产生 Warning 或 Error，出了问题不了解情况的话还是比较难发现的。</p>
<p>可以预见（事实）的是，当 <code>Access-Control-Allow-Origin</code> 指定了唯一域名后，使用其它域名访问该 API 也会出现无效的问题。不过相应地也有一个取巧的办法，就是将它设置为 Request 的 Origin Header，这样一来问题就解决了。</p>
</div> <hr data-v-f233b600=""> <nav data-v-7144c3e4="" data-v-f233b600=""><ul data-v-7144c3e4="" class="pager"><li data-v-7144c3e4="" class="previous"><a data-v-7144c3e4="" href="/p/holiday-soon-finally" class=""><i data-v-7144c3e4="" class="glyphicon glyphicon-chevron-left"></i> 终于要放假了
      </a></li> <li data-v-7144c3e4="" class="next"><a data-v-7144c3e4="" href="/p/difference-between-npm-dependencies-types" class="">
        Difference Between NPM Dependencies Types <i data-v-7144c3e4="" class="glyphicon glyphicon-chevron-right"></i></a></li></ul></nav> <hr data-v-f233b600=""> <div data-v-1a6fe007="" data-v-f233b600="" id="disqus_thread"><i data-v-1a6fe007="" class="glyphicon glyphicon-refresh icon-spin"></i> <span data-v-1a6fe007="">Loading Disqus......</span></div></section></section></div></div></div></div> <section data-v-f9dc3034="" data-v-79039cdb="" class="page-footer"><div data-v-f9dc3034="" class="container-fluid"><div data-v-f9dc3034="" class="row"><div data-v-f9dc3034="" class="col-xs-12"><p data-v-f9dc3034=""><span data-v-f9dc3034="">Links:</span> <!----> <a data-v-f9dc3034="" href="https://blog.aquariuslt.com/" target="_blank">Aquariuslt</a><span data-v-f9dc3034="">&nbsp;/</span> <a data-v-f9dc3034="" href="https://lz5z.com" target="_blank">Leo's Blog</a></p></div></div> <div data-v-f9dc3034="" class="row"><div data-v-f9dc3034="" class="col-xs-12"><a data-v-f9dc3034="" href="https://wxsm.space">© 2018 WXSM</a> <span data-v-f9dc3034="">/</span> <a data-v-f9dc3034="" href="/feed.xml" rel="nofollow" target="_blank">FEED</a> <span data-v-f9dc3034="">/</span> <a data-v-f9dc3034="" title="LICENSE" href="https://creativecommons.org/licenses/by/4.0/" rel="nofollow">CC BY 4.0</a></div></div></div></section></section></section>
<div id="nprogress" style="transition: none; -webkit-transition: none; opacity: 1;"><div class="bar" role="bar" style="transition: all 200ms ease; -webkit-transition: all 200ms ease; -webkit-transform: translate3d(0%, 0px, 0px);"><div class="peg"></div></div></div></body></html>
