<!DOCTYPE html><html class="nprogress-busy"><head><meta charset="utf-8"><meta name="google-site-verification" content="ekuL5J7xK1IdFtP13v3KxpuGKnYS1oCT9PvZdjYm8Eg"><meta name="viewport" content="user-scalable=no,width=device-width,initial-scale=1,maximum-scale=1"><link rel="shortcut icon" type="image/png" href="/static/favicon.png"><link rel="apple-touch-icon" sizes="200x200" href="/static/favicon-iphone.png"><title>wxsm's space - 关于 Moment.js 的一些思考</title><meta name="description" content="wxsms's personal blog."><meta name="keywords" content="Blog,JavaScript,HTML,CSS,Vue,Bootstrap"><link href="/static/css/app.c460d3b13d6d7ce0c63faa74a9023a8f.css" rel="stylesheet"><script type="text/javascript" src="/static/js/manifest.68263eefe155d055bfa0.js"></script><script type="text/javascript" src="/static/js/vendor.19a2875ac58b9bf76cc9.js"></script><script type="text/javascript" src="/static/js/app.6317672e36f60ab5ad32.js"></script><script async="" src="https://www.google-analytics.com/analytics.js" charset="utf8"></script><script async="" src="https://www.google-analytics.com/analytics.js" charset="utf8"></script><script type="text/javascript" charset="utf-8" async="" src="/static/js/0.24af7fe1e27d3b16bd28.js"></script><script type="text/javascript" charset="utf-8" async="" src="/static/js/4.f6eaab3002dc8add016f.js"></script><script type="text/javascript" charset="utf-8" async="" src="/static/js/0.24af7fe1e27d3b16bd28.js"></script><script type="text/javascript" charset="utf-8" async="" src="/static/js/1.3d038e42bb029d58fb1c.js"></script><script type="text/javascript" async="" id="embed-disqus" data-timestamp="1539144376702" src="//wxsm.disqus.com/embed.js"></script><link rel="prefetch" href="https://c.disquscdn.com/next/embed/styles/lounge.d797d52db05c56e7ec33542889f90bca.css"><link rel="prefetch" href="https://c.disquscdn.com/next/embed/common.bundle.18932c85febf9520158697cdc31f08ae.js"><link rel="prefetch" href="https://c.disquscdn.com/next/embed/lounge.bundle.ab905f052ba8af95ba7fd0785f080e6d.js"><link rel="prefetch" href="https://disqus.com/next/config.js"></head><body><section id="app"><section data-v-6a2c05ce="" style="display: none;"></section> <aside data-v-0044a876="" class=""><div data-v-0044a876="" class="brand"><h4 data-v-0044a876="" class="brand-link"><a data-v-0044a876="" href="/" class="router-link-active">wxsm's space</a></h4></div> <div data-v-0044a876="" class="search-container"><form data-v-e01410e2="" data-v-0044a876="" class="form-inline search-form-box"><div data-v-e01410e2="" class="form-group"><input data-v-e01410e2="" type="search" placeholder="Search..." required="required" minlength="2" class="form-control"></div></form></div> <div data-v-0044a876="" class="nav-container"><div data-v-0044a876="" class="nav-div"><ul data-v-0044a876="" role="tablist" class="nav nav-pills nav-stacked"><li data-v-0044a876="" role="presentation"><a data-v-0044a876="" href="/p" class="router-link-active btn btn-link" role="button">Archive</a></li><li data-v-0044a876="" role="presentation"><a data-v-0044a876="" href="/t" class="btn btn-link" role="button">Tags</a></li><li data-v-0044a876="" role="presentation"><a data-v-0044a876="" href="/g" class="btn btn-link" role="button">Guestbook</a></li><li data-v-0044a876="" role="presentation"><a data-v-0044a876="" href="/a" class="btn btn-link" role="button">About</a></li></ul></div> <!----></div></aside> <section data-v-79039cdb="" class="page"><div data-v-79039cdb="" class="page-body"><button data-v-01aba251="" data-v-79039cdb="" type="button" class="navbar-toggle collapsed"><span data-v-01aba251="" class="sr-only">Toggle navigation</span> <span data-v-01aba251="" class="icon-bar"></span> <span data-v-01aba251="" class="icon-bar"></span> <span data-v-01aba251="" class="icon-bar"></span></button> <div data-v-79039cdb="" class="container-fluid"><div data-v-79039cdb="" class="row"><div data-v-79039cdb="" class="col-xs-12"><section data-v-f233b600="" data-v-79039cdb=""><h1 data-v-f233b600="">关于 Moment.js 的一些思考</h1> <section data-v-f233b600="" id="post-content"><section data-v-19e352bd="" data-v-f233b600=""><div data-v-19e352bd="" class="meta-block"><i data-v-19e352bd="" class="glyphicon glyphicon-calendar"></i> <span data-v-19e352bd="">January 24, 2018</span></div> <!----></section> <div data-v-f233b600=""><!-- 「」 -->
<p><a href="https://momentjs.com/">Moment.js</a> 是一个流行的基于 JavaScript 的时间处理工具库。应该是一个从 2011 年开始启动的项目，至今它的 <a href="https://github.com/moment/moment">Github repo</a> 也有了 3w+ 的星星，可以说在前端界人尽皆知了。反正我自从用了它基本上就没再接触过其它的相关库。</p>
<p>但最近我却对它的看法却产生了些许改变。原因是，它的 API 设计给使用者埋下了巨大无比的坑，简单来说：“名不副实”。</p>
<!-- more -->
<p>具体看图吧：</p>
<p><img src="https://raw.githubusercontent.com/wxsms/wxsms-img-holder/master/Selection_003.png" alt="strange-moment-js"></p>
<p>很明显，调用 Moment.js 的 API 产生了预期之外的副作用。函数在带有返回值的同时却又对原始值进行了修改，违反了基本的 OO 设计原则。</p>
<blockquote>
<p><strong>Command–query separation (CQS)</strong> is a principle of imperative computer programming. It was devised by Bertrand Meyer as part of his pioneering work on the Eiffel programming language. <strong>It states that every method should either be a command that performs an action, or a query that returns data to the caller, but not both.</strong> In other words, Asking a question should not change the answer. More formally, methods should return a value only if they are referentially transparent and hence possess no side effects.</p>
</blockquote>
<p>也就是说，设计一个函数，它应该：</p>
<ul>
<li>要么进行操作（Mutable）；</li>
<li>要么进行返回（Immutable）；</li>
<li>但，以上两点不能同时进行。</li>
</ul>
<p>这里的“返回”，我的理解不是所有类型的返回，而是特指与原始值相对应的返回。</p>
<p>比如说，在 JavaScript 世界中 <code>array.slice</code> 是一个 Immutable 类型的函数，它不会对输入值进行改变，而是返回一份 copy：</p>
<blockquote>
<p>The <code>slice()</code> method returns a shallow copy of a portion of an array into a new array object selected from begin to end (end not included). The original array will not be modified.</p>
</blockquote>
<p>但 <code>array.splice</code> 则不同（它虽然也有返回值，但跟输入值并不是对应的关系了）：</p>
<blockquote>
<p>The <code>splice()</code> method changes the contents of an array by removing existing elements and/or adding new elements. Return value: An array containing the deleted elements.</p>
</blockquote>
<p>同理还有 <code>array.push</code> / <code>array.pop</code> 等。</p>
<p><strong>而 Moment.js 是如何设计的呢？</strong></p>
<p>这里有一个 issue，通过它，基本可以看出来 Moment 有哪些 API 是有问题的：<a href="https://github.com/moment/moment/issues/1754">make moment mostly immutable #1754</a></p>
<p>比如一个简单的 <code>add</code> 方法，对日期进行“加”操作（比如日期加一天）。那么它应该是这样的：</p>
<ul>
<li>要么直接对输入进行“加”操作；</li>
<li>要么产生一份复制值，对复制进行“加”操作并返回。</li>
</ul>
<p>但是，Moment 真正的做法是，直接对输入进行“加”操作，并且返回。这样就很让人头疼了。</p>
<p>更过分的就是上图的例子，名如 <code>startOf</code> / <code>endOf</code> 这样的方法，看起来像是 Immutable 操作，实际上却还是 Mutable 的。所以说，如果用户使用了 Moment，那么所有的原始输入值基本上都是无法得到任何保证。你根本不知道输入值在什么时候就被修改了。</p>
<p>值得欣慰的是，在 Moment 发展了三年以后的 2014 年，终于有人提出了上述问题，并且被维护者认可并加入版本计划中了。但是，三年之后又三年，如今已经到了 2018，问题依旧没有得到解决。在 ES 发展如此迅速的时代，一个基本上处于垄断地位的流行库，以及一个三年都没能解决的问题，不知道是否还有救？</p>
<p>不过也许它已经完成曲线救国了（推倒重来总是比较简单）：<a href="https://github.com/moment/luxon">https://github.com/moment/luxon</a></p>
<blockquote>
<p>Features: Immutable, chainable, unambiguous API.</p>
</blockquote>
<p>不可否认 Moment.js 确实帮助开发者解决了很多问题，节省了大量时间。但是有一个问题：一个质量如此的库，是如何做到流行，如何拿到 3w 个 stars 的呢？是不是包括我在内的这些开发者，从根本上就存在软件开发基础知识的不足呢。</p>
</div> <hr data-v-f233b600=""> <nav data-v-7144c3e4="" data-v-f233b600=""><ul data-v-7144c3e4="" class="pager"><li data-v-7144c3e4="" class="previous"><a data-v-7144c3e4="" href="/p/linux-setup-for-work" class=""><i data-v-7144c3e4="" class="glyphicon glyphicon-chevron-left"></i> Linux Setup for Work
      </a></li> <li data-v-7144c3e4="" class="next"><a data-v-7144c3e4="" href="/p/auto-height-webview-of-react-native" class="">
        Auto-height Webview of ReactNative <i data-v-7144c3e4="" class="glyphicon glyphicon-chevron-right"></i></a></li></ul></nav> <hr data-v-f233b600=""> <div data-v-1a6fe007="" data-v-f233b600="" id="disqus_thread"><iframe id="dsq-app4314" name="dsq-app4314" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="https://disqus.com/embed/comments/?base=default&amp;f=wxsm&amp;t_i=%2Fp%2Fsome-thougths-about-momentjs&amp;t_u=https%3A%2F%2Fblog.wxsm.space%2Fp%2Fsome-thougths-about-momentjs&amp;t_d=wxsm's%20space%20-%20%E5%85%B3%E4%BA%8E%20Moment.js%20%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83&amp;t_t=wxsm's%20space%20-%20%E5%85%B3%E4%BA%8E%20Moment.js%20%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83&amp;s_o=default#version=91b68efe0df1ae8547330866c3e10b29" style="width: 1px !important; min-width: 100% !important; border: none !important; overflow: hidden !important; height: 0px !important;"></iframe></div></section></section></div></div></div></div> <section data-v-f9dc3034="" data-v-79039cdb="" class="page-footer"><div data-v-f9dc3034="" class="container-fluid"><div data-v-f9dc3034="" class="row"><div data-v-f9dc3034="" class="col-xs-12"><p data-v-f9dc3034=""><span data-v-f9dc3034="">Links:</span> <!----> <a data-v-f9dc3034="" href="https://blog.aquariuslt.com/" target="_blank">Aquariuslt</a><span data-v-f9dc3034="">&nbsp;/</span> <a data-v-f9dc3034="" href="https://lz5z.com" target="_blank">Leo's Blog</a></p></div></div> <div data-v-f9dc3034="" class="row"><div data-v-f9dc3034="" class="col-xs-12"><a data-v-f9dc3034="" href="https://wxsm.space">© 2018 WXSM</a> <span data-v-f9dc3034="">/</span> <a data-v-f9dc3034="" href="/feed.xml" rel="nofollow" target="_blank">FEED</a> <span data-v-f9dc3034="">/</span> <a data-v-f9dc3034="" title="LICENSE" href="https://creativecommons.org/licenses/by/4.0/" rel="nofollow">CC BY 4.0</a></div></div></div></section></section></section>
<div id="nprogress" style="transition: all 200ms linear; -webkit-transition: all 200ms linear; opacity: 0;"><div class="bar" role="bar" style="transition: all 200ms ease; -webkit-transition: all 200ms ease; -webkit-transform: translate3d(0%, 0px, 0px);"><div class="peg"></div></div></div><iframe style="display: none;"></iframe></body></html>
