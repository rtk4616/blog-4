<!DOCTYPE html><html class="nprogress-busy"><head><meta charset="utf-8"><meta name="google-site-verification" content="ekuL5J7xK1IdFtP13v3KxpuGKnYS1oCT9PvZdjYm8Eg"><meta name="viewport" content="user-scalable=no,width=device-width,initial-scale=1,maximum-scale=1"><link rel="shortcut icon" type="image/png" href="/static/favicon.png"><link rel="apple-touch-icon" sizes="200x200" href="/static/favicon-iphone.png"><title>wxsm's space - Gitlab CI Setup</title><meta name="description" content="wxsms's personal blog."><meta name="keywords" content="Blog,JavaScript,HTML,CSS,Vue,Bootstrap"><link href="/static/css/app.c460d3b13d6d7ce0c63faa74a9023a8f.css" rel="stylesheet"><script type="text/javascript" src="/static/js/manifest.68263eefe155d055bfa0.js"></script><script type="text/javascript" src="/static/js/vendor.19a2875ac58b9bf76cc9.js"></script><script type="text/javascript" src="/static/js/app.6317672e36f60ab5ad32.js"></script><script async="" src="https://www.google-analytics.com/analytics.js" charset="utf8"></script><script async="" src="https://www.google-analytics.com/analytics.js" charset="utf8"></script><script type="text/javascript" charset="utf-8" async="" src="/static/js/0.24af7fe1e27d3b16bd28.js"></script><script type="text/javascript" charset="utf-8" async="" src="/static/js/4.f6eaab3002dc8add016f.js"></script><script type="text/javascript" charset="utf-8" async="" src="/static/js/0.24af7fe1e27d3b16bd28.js"></script><script type="text/javascript" charset="utf-8" async="" src="/static/js/1.3d038e42bb029d58fb1c.js"></script></head><body><section id="app"><section data-v-6a2c05ce="" style="display: none;"></section> <aside data-v-0044a876="" class=""><div data-v-0044a876="" class="brand"><h4 data-v-0044a876="" class="brand-link"><a data-v-0044a876="" href="/" class="router-link-active">wxsm's space</a></h4></div> <div data-v-0044a876="" class="search-container"><form data-v-e01410e2="" data-v-0044a876="" class="form-inline search-form-box"><div data-v-e01410e2="" class="form-group"><input data-v-e01410e2="" type="search" placeholder="Search..." required="required" minlength="2" class="form-control"></div></form></div> <div data-v-0044a876="" class="nav-container"><div data-v-0044a876="" class="nav-div"><ul data-v-0044a876="" role="tablist" class="nav nav-pills nav-stacked"><li data-v-0044a876="" role="presentation"><a data-v-0044a876="" href="/p" class="router-link-active btn btn-link" role="button">Archive</a></li><li data-v-0044a876="" role="presentation"><a data-v-0044a876="" href="/t" class="btn btn-link" role="button">Tags</a></li><li data-v-0044a876="" role="presentation"><a data-v-0044a876="" href="/g" class="btn btn-link" role="button">Guestbook</a></li><li data-v-0044a876="" role="presentation"><a data-v-0044a876="" href="/a" class="btn btn-link" role="button">About</a></li></ul></div> <!----></div></aside> <section data-v-79039cdb="" class="page"><div data-v-79039cdb="" class="page-body"><button data-v-01aba251="" data-v-79039cdb="" type="button" class="navbar-toggle collapsed"><span data-v-01aba251="" class="sr-only">Toggle navigation</span> <span data-v-01aba251="" class="icon-bar"></span> <span data-v-01aba251="" class="icon-bar"></span> <span data-v-01aba251="" class="icon-bar"></span></button> <div data-v-79039cdb="" class="container-fluid"><div data-v-79039cdb="" class="row"><div data-v-79039cdb="" class="col-xs-12"><section data-v-f233b600="" data-v-79039cdb=""><h1 data-v-f233b600="">Gitlab CI Setup</h1> <section data-v-f233b600="" id="post-content"><section data-v-19e352bd="" data-v-f233b600=""><div data-v-19e352bd="" class="meta-block"><i data-v-19e352bd="" class="glyphicon glyphicon-calendar"></i> <span data-v-19e352bd="">July 19, 2018</span></div> <div data-v-19e352bd="" class="meta-block"><a data-v-3cd447cb="" data-v-19e352bd="" href="/t#CI" class="label-tag"><span data-v-3cd447cb="" class="label label-default">CI</span></a><a data-v-3cd447cb="" data-v-19e352bd="" href="/t#Gitlab" class="label-tag"><span data-v-3cd447cb="" class="label label-warning">Gitlab</span></a></div></section> <div data-v-f233b600=""><!-- ã€Œã€ -->
<p>Gitlab æœ‰ä¸€å¥—å†…ç½®çš„ CI ç³»ç»Ÿï¼Œç›¸æ¯”é›†æˆ Jenkins æ¥è¯´æ›´åŠ æ–¹ä¾¿ä¸€äº›ï¼Œç”¨æ³•ä¹Ÿç¨ä¸ºç®€å•ã€‚ä»¥ä¸‹æ˜¯æ­å»ºè¿‡ç¨‹ã€‚</p>
<p>å‰ç½®å‡†å¤‡ï¼šé¡»è¦å‡†å¤‡ä¸€å°ç”¨æ¥è·‘ CI ä»»åŠ¡çš„æœºå™¨ï¼ˆå¯ä»¥æ˜¯ Mac / Linux / Windows ä¹‹ä¸€ï¼‰ã€‚</p>
<!-- more -->
<h2 id="gitlab-ciyml">åˆ›å»º <code>.gitlab-ci.yml</code> æ–‡ä»¶ <a class="header-anchor" href="#gitlab-ciyml" aria-hidden="true">ğŸ”—</a></h2>
<p>å’Œ Github CI ä¸€æ ·ï¼ŒGitlab CI ä¹Ÿä½¿ç”¨ <a href="https://en.wikipedia.org/wiki/YAML">YAML</a> æ–‡ä»¶æ¥å®šä¹‰é¡¹ç›®çš„æ•´ä¸ªæ„å»ºä»»åŠ¡ã€‚åªè¦åœ¨éœ€è¦é›†æˆ CI çš„é¡¹ç›®æ ¹ç›®å½•ä¸‹æ·»åŠ è¿™ä»½æ–‡ä»¶å¹¶å†™å…¥å†…å®¹ï¼Œé»˜è®¤æƒ…å†µä¸‹ Gitlab å°±ä¼šä¸ºæ­¤é¡¹ç›®å¯ç”¨æ„å»ºã€‚</p>
<p>é…ç½®æ–‡æ¡£ï¼š<a href="https://docs.gitlab.com/ee/ci/yaml/README.html">https://docs.gitlab.com/ee/ci/yaml/README.html</a></p>
<p>ä¸€ä»½è¾ƒä¸ºå®Œæ•´çš„é…ç½®æ–‡ä»¶æ ·ä¾‹ï¼š</p>
<pre><code class="language-yaml"><span class="hljs-comment"># æŒ‡å®š docker é•œåƒ</span>
<span class="hljs-attr">image:</span> <span class="hljs-attr">node:9.3.0</span>

<span class="hljs-comment"># ä¸º docker é•œåƒå®‰è£… ssh-agent ä»¥æ‰§è¡Œéƒ¨ç½²ä»»åŠ¡</span>
<span class="hljs-attr">before_script:</span>
<span class="hljs-bullet">  -</span> <span class="hljs-string">'which ssh-agent || ( apt-get update -y &amp;&amp; apt-get install openssh-client -y )'</span>
<span class="hljs-bullet">  -</span> <span class="hljs-string">eval</span> <span class="hljs-string">$(ssh-agent</span> <span class="hljs-bullet">-s)</span>
<span class="hljs-bullet">  -</span> <span class="hljs-string">echo</span> <span class="hljs-string">"$SSH_PRIVATE_KEY"</span> <span class="hljs-string">| tr -d '\r' | ssh-add - &gt; /dev/null
  - mkdir -p ~/.ssh
  - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" &gt; ~/.ssh/config
  - chmod 700 ~/.ssh

# å®šä¹‰æ„å»ºçš„ä¸‰ä¸ªé˜¶æ®µ
</span><span class="hljs-attr">stages:</span>
<span class="hljs-bullet">  -</span> <span class="hljs-string">build</span>
<span class="hljs-bullet">  -</span> <span class="hljs-string">test</span>
<span class="hljs-bullet">  -</span> <span class="hljs-string">deploy</span>

<span class="hljs-comment"># å®šä¹‰å¯ç¼“å­˜çš„æ–‡ä»¶å¤¹</span>
<span class="hljs-attr">cache:</span>
<span class="hljs-attr">  paths:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">node_modules/</span>

<span class="hljs-comment"># æ„å»ºä»»åŠ¡</span>
<span class="hljs-attr">build-job:</span>
<span class="hljs-attr">  stage:</span> <span class="hljs-string">build</span>
<span class="hljs-attr">  script:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">"npm install"</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">"npm run build"</span>
<span class="hljs-attr">  tags:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">node</span>

<span class="hljs-comment"># æµ‹è¯•ä»»åŠ¡</span>
<span class="hljs-attr">test-job:</span>
<span class="hljs-attr">  stage:</span> <span class="hljs-string">test</span>
<span class="hljs-attr">  script:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">"npm install"</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">"npm run lint"</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">"npm test"</span>
<span class="hljs-attr">  tags:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">node</span>

<span class="hljs-comment"># éƒ¨ç½²ä»»åŠ¡</span>
<span class="hljs-attr">deploy-job:</span>
<span class="hljs-attr">  stage:</span> <span class="hljs-string">deploy</span>
<span class="hljs-attr">  only:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">release</span>
<span class="hljs-attr">  script:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">"npm install"</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">"npm run build"</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">ssh</span> <span class="hljs-string">user@host</span> <span class="hljs-string">"[any shell commands]"</span>
<span class="hljs-attr">  tags:</span>
<span class="hljs-bullet">    -</span> <span class="hljs-string">node</span>
</code></pre>
<p>æ•´ä¸ªæ„å»ºè¿‡ç¨‹åŸºæœ¬ä¸Šä¸€ç›®äº†ç„¶ï¼Œæ¯” Jenkins ç®€ä¾¿å¾ˆå¤šã€‚Gitlab CI ä¼šæŒ‰é¡ºåºæ‰§è¡Œ build / test / deploy ä¸‰ä¸ª stage çš„ä»»åŠ¡ï¼Œé‡åˆ°å‡ºé”™å³ä¸­æ­¢ï¼Œå¹¶ä¸å†å¾€ä¸‹æ‰§è¡Œã€‚åŒä¸ª stage ä¸­çš„å¤šä¸ªä»»åŠ¡ä¼šå¹¶å‘æ‰§è¡Œã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå„ä¸ª stage çš„å·¥ä½œç©ºé—´æ˜¯ç‹¬ç«‹çš„ã€‚</p>
<p>å…¶ä¸­ <code>$SSH_PRIVATE_KEY</code> æ˜¯åœ¨ç›¸åº” Gitlab é¡¹ç›®ä¸­é…ç½®çš„ä¸€ä¸ª Secret Valueï¼Œæ˜¯æ„å»ºæœºçš„ ssh ç§é’¥ã€‚åé¢å†è°ˆã€‚</p>
<p>å°† <code>.gitlab-ci.yml</code> æ–‡ä»¶æ¨é€åˆ°æœåŠ¡å™¨åï¼Œæ‰“å¼€é¡¹ç›®ä¸»é¡µï¼Œç‚¹å‡» Commit è®°å½•ï¼Œä¼šå‘ç°æ„å»ºä»»åŠ¡å¯åŠ¨å¹¶å¤„äº pending çŠ¶æ€ï¼š</p>
<p><img src="https://docs.gitlab.com/ee/ci/quick_start/img/new_commit.png" alt="img"></p>
<p>ç‚¹å‡»æ„å»ºå›¾æ ‡ï¼Œåˆ™å¯ä»¥è¿›å…¥åˆ° CI è¯¦æƒ…é¡µé¢ï¼š</p>
<p><img src="https://docs.gitlab.com/ee/ci/quick_start/img/single_commit_status_pending.png" alt="img"></p>
<p>ç‚¹å‡»å…·ä½“ä»»åŠ¡æŸ¥çœ‹ log åˆ™æç¤ºé¡¹ç›®æ²¡æœ‰é…ç½®ç›¸åº”çš„ runner æ¥æ‰§è¡Œæ„å»ºä»»åŠ¡ã€‚ä¹Ÿå°±æ˜¯ä¸‹ä¸€æ­¥è¦åšçš„äº‹æƒ…ã€‚</p>
<h2 id="gitlab-runner">æ­å»º Gitlab runner <a class="header-anchor" href="#gitlab-runner" aria-hidden="true">ğŸ”—</a></h2>
<p><a href="https://docs.gitlab.com/runner/">Gitlab runner</a> æ˜¯ç”¨æ¥æ‰§è¡Œ CI ä»»åŠ¡çš„å®¢æˆ·ç«¯ï¼Œå®ƒå¯ä»¥åœ¨ä¸€å°æœºå™¨ä¸Šæ­å»ºï¼Œå¹¶ä¸”åŒæ—¶ä¸ºå¤šä¸ªé¡¹ç›®æœåŠ¡ã€‚<a href="https://docs.gitlab.com/runner/install/">å®‰è£…æ•™ç¨‹</a>ã€‚</p>
<p>å®‰è£…å¥½ runner åï¼Œè¿˜è¦ä¸ºæœºå™¨å®‰è£… <a href="https://www.docker.com/community-edition">Docker</a>ï¼Œç”¨æ¥ä½œä¸ºå…·ä½“æ„å»ºçš„å®¹å™¨ã€‚</p>
<p>ä»¥ä¸Šå‡å®‰è£…å®Œæˆåï¼Œå°±å¯ä»¥å¼€å§‹é…ç½® runner äº†ã€‚é…ç½®è¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°çš„ä¸€äº›ä¿¡æ¯å¯ä»¥åœ¨ä¸‹å›¾ä½ç½®æ‰¾åˆ°ï¼ˆé¡¹ç›®ä¸»é¡µ -&gt; Settings -&gt; CI / CD -&gt; Runners settingsï¼‰ã€‚</p>
<p><img src="https://docs.gitlab.com/ee/ci/quick_start/img/runners_activated.png" alt="img"></p>
<pre><code>$ sudo gitlab-runner register

Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com )
(å¡«å†™ä¸Šå›¾ä½ç½®çš„åœ°å€)

Please enter the gitlab-ci token for this runner
(å¡«å†™ä¸Šå›¾ä½ç½®çš„token)

Please enter the gitlab-ci description for this runner
[hostame] my-runner

Please enter the gitlab-ci tags for this runner (comma separated):
node

Please enter the executor: ssh, docker+machine, docker-ssh+machine, kubernetes, docker, parallels, virtualbox, docker-ssh, shell:
docker

Please enter the Docker image (eg. ruby:2.1):
node:latest
</code></pre>
<p>å…¶ä¸­ description ä¸ tags å°†æ¥éƒ½å¯ä»¥åœ¨ Gitlab UI ä¸­æ›´æ”¹ã€‚æ³¨æ„ tag å¿…é¡»ä¸ <code>.gitlab-ci.yml</code> ä¸­å„ä¸ª job æŒ‡å®šçš„ tag ä¸€è‡´ï¼Œè¿™ä¸ª job æ‰ä¼šåˆ†é…åˆ°è¿™ä¸ª runner ä¸Šå»ã€‚</p>
<p>å¦‚æ­¤ä¸€æ¥åˆ™å¤§åŠŸå‘Šæˆï¼Œå›åˆ° Gitlab UIï¼Œåœ¨ Runner settings å†…å¯ä»¥çœ‹åˆ°é…ç½®å¥½çš„ runnerï¼Œå¹¶ä¸”å¯ä»¥æ‰§è¡Œä»»åŠ¡äº†ã€‚</p>
<p><img src="https://docs.gitlab.com/ee/ci/quick_start/img/pipelines_status.png" alt="img"></p>
<h2 id="">é‡åˆ°çš„é—®é¢˜ <a class="header-anchor" href="#" aria-hidden="true">ğŸ”—</a></h2>
<p>å…¶å®æœ¬åœ°æ„å»ºåŸºæœ¬ä¸Šéƒ½æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œé‡åˆ°çš„å‘åŸºæœ¬é›†ä¸­åœ¨ deploy é˜¶æ®µï¼Œå³è¿œç¨‹åˆ°æœåŠ¡å™¨ä¸Šå»å‘å¸ƒçš„è¿™ä¸€æ­¥ã€‚æŒ‰ç…§ Gitlab æä¾›çš„<a href="https://docs.gitlab.com/ee/ci/ssh_keys/">æ–‡æ¡£</a>ï¼Œèµ°å®Œäº†æ‰€æœ‰çš„æ­¥éª¤åï¼Œæ„å»ºæœºæ€»æ˜¯æ— æ³•ä½¿ç”¨ private key ç›´æ¥ç™»å½•ï¼Œè€Œæ˜¯å¿…é¡»è¾“å…¥å¯†ç ç™»å½•ã€‚å°è¯•äº†æŸ¥çœ‹ ssh æ—¥å¿—ï¼Œé‡å¯æœåŠ¡å™¨ sshd æœåŠ¡ï¼Œä¿®æ”¹æ–‡ä»¶å¤¹æƒé™ç­‰ç­‰ï¼Œdebug äº†åŠå¤©è¿˜æ˜¯æ²¡æœ‰è§£å†³è¯¥é—®é¢˜ã€‚åæ¥å¶ç„¶å‘ç°åœ¨éƒ¨ç½²æœåŠ¡å™¨ä¸Šä½¿ç”¨ sshd å¼€å¯ä¸€ä¸ªæ–°çš„æœåŠ¡ï¼Œç”¨æ–°çš„ç«¯å£å³å¯é¡ºåˆ©ç™»å½•ï¼Œä¹Ÿä¸çŸ¥é“æ˜¯ä¸ºä»€ä¹ˆã€‚</p>
<p>æ›´æ–°ï¼šå¦å¤–ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ä½¿ç”¨ <code>sshpass</code> å‘½ä»¤æ¥è¿›è¡Œç™»å½•ã€‚ç”¨æ³•ï¼š</p>
<ol>
<li>åœ¨ docker é•œåƒä¸­å®‰è£… <code>sshpass</code><pre><code>$ which sshpass || ( apt-get update -y &amp;&amp; apt-get install sshpass -y )
</code></pre>
å…¶ä¸­ <code>-y</code> æ˜¯ä¸ºäº†é˜²æ­¢å®‰è£…è¿‡ç¨‹ä¸­å‡ºç°éœ€è¦é€‰æ‹©çš„é¡¹ç›®ï¼Œä¸€å¾‹é€‰ YES</li>
<li>åœ¨é¡¹ç›® CI å˜é‡ä¸­è®¾ç½® ssh å¯†ç </li>
<li>ä½¿ç”¨ <code>sshpass</code> å¤åˆ¶æ–‡ä»¶ï¼Œæˆ–ç™»å½•è¿œç¨‹æœåŠ¡å™¨<pre><code># scp
$ SSHPASS=$YOUR_PASSWORD_VAR sshpass -e scp -r local_folder user@host:remote_folder"
# ssh
$ SSHPASS=$YOUR_PASSWORD_VAR sshpass -e ssh user@host
</code></pre>
</li>
</ol>
</div> <hr data-v-f233b600=""> <nav data-v-7144c3e4="" data-v-f233b600=""><ul data-v-7144c3e4="" class="pager"><li data-v-7144c3e4="" class="previous"><a data-v-7144c3e4="" href="/p/dying-to-survive" class=""><i data-v-7144c3e4="" class="glyphicon glyphicon-chevron-left"></i> ä¸­å›½è¯ç¥
      </a></li> <li data-v-7144c3e4="" class="next"><a data-v-7144c3e4="" href="/p/disappointed" class="">
        å¤±æœ› <i data-v-7144c3e4="" class="glyphicon glyphicon-chevron-right"></i></a></li></ul></nav> <hr data-v-f233b600=""> <div data-v-1a6fe007="" data-v-f233b600="" id="disqus_thread"><i data-v-1a6fe007="" class="glyphicon glyphicon-refresh icon-spin"></i> <span data-v-1a6fe007="">Loading Disqus......</span></div></section></section></div></div></div></div> <section data-v-f9dc3034="" data-v-79039cdb="" class="page-footer"><div data-v-f9dc3034="" class="container-fluid"><div data-v-f9dc3034="" class="row"><div data-v-f9dc3034="" class="col-xs-12"><p data-v-f9dc3034=""><span data-v-f9dc3034="">Links:</span> <!----> <a data-v-f9dc3034="" href="https://blog.aquariuslt.com/" target="_blank">Aquariuslt</a><span data-v-f9dc3034="">&nbsp;/</span> <a data-v-f9dc3034="" href="https://lz5z.com" target="_blank">Leo's Blog</a></p></div></div> <div data-v-f9dc3034="" class="row"><div data-v-f9dc3034="" class="col-xs-12"><a data-v-f9dc3034="" href="https://wxsm.space">Â© 2018 WXSM</a> <span data-v-f9dc3034="">/</span> <a data-v-f9dc3034="" href="/feed.xml" rel="nofollow" target="_blank">FEED</a> <span data-v-f9dc3034="">/</span> <a data-v-f9dc3034="" title="LICENSE" href="https://creativecommons.org/licenses/by/4.0/" rel="nofollow">CC BY 4.0</a></div></div></div></section></section></section>
<div id="nprogress" style="transition: none; -webkit-transition: none; opacity: 1;"><div class="bar" role="bar" style="transition: all 200ms ease; -webkit-transition: all 200ms ease; -webkit-transform: translate3d(0%, 0px, 0px);"><div class="peg"></div></div></div></body></html>
