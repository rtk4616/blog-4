<!DOCTYPE html><html class="nprogress-busy"><head><meta charset="utf-8"><meta name="google-site-verification" content="ekuL5J7xK1IdFtP13v3KxpuGKnYS1oCT9PvZdjYm8Eg"><meta name="viewport" content="user-scalable=no,width=device-width,initial-scale=1,maximum-scale=1"><link rel="shortcut icon" type="image/png" href="/static/favicon.png"><link rel="apple-touch-icon" sizes="200x200" href="/static/favicon-iphone.png"><title>wxsm's space - Koa Note</title><meta name="description" content="wxsms's personal blog."><meta name="keywords" content="Blog,JavaScript,HTML,CSS,Vue,Bootstrap"><link href="/static/css/app.c460d3b13d6d7ce0c63faa74a9023a8f.css" rel="stylesheet"><script type="text/javascript" src="/static/js/manifest.68263eefe155d055bfa0.js"></script><script type="text/javascript" src="/static/js/vendor.19a2875ac58b9bf76cc9.js"></script><script type="text/javascript" src="/static/js/app.6317672e36f60ab5ad32.js"></script><script async="" src="https://www.google-analytics.com/analytics.js" charset="utf8"></script><script async="" src="https://www.google-analytics.com/analytics.js" charset="utf8"></script><script type="text/javascript" charset="utf-8" async="" src="/static/js/0.24af7fe1e27d3b16bd28.js"></script><script type="text/javascript" charset="utf-8" async="" src="/static/js/4.f6eaab3002dc8add016f.js"></script><script type="text/javascript" charset="utf-8" async="" src="/static/js/0.24af7fe1e27d3b16bd28.js"></script><script type="text/javascript" charset="utf-8" async="" src="/static/js/1.3d038e42bb029d58fb1c.js"></script></head><body><section id="app"><section data-v-6a2c05ce="" style="display: none;"></section> <aside data-v-0044a876="" class=""><div data-v-0044a876="" class="brand"><h4 data-v-0044a876="" class="brand-link"><a data-v-0044a876="" href="/" class="router-link-active">wxsm's space</a></h4></div> <div data-v-0044a876="" class="search-container"><form data-v-e01410e2="" data-v-0044a876="" class="form-inline search-form-box"><div data-v-e01410e2="" class="form-group"><input data-v-e01410e2="" type="search" placeholder="Search..." required="required" minlength="2" class="form-control"></div></form></div> <div data-v-0044a876="" class="nav-container"><div data-v-0044a876="" class="nav-div"><ul data-v-0044a876="" role="tablist" class="nav nav-pills nav-stacked"><li data-v-0044a876="" role="presentation"><a data-v-0044a876="" href="/p" class="router-link-active btn btn-link" role="button">Archive</a></li><li data-v-0044a876="" role="presentation"><a data-v-0044a876="" href="/t" class="btn btn-link" role="button">Tags</a></li><li data-v-0044a876="" role="presentation"><a data-v-0044a876="" href="/g" class="btn btn-link" role="button">Guestbook</a></li><li data-v-0044a876="" role="presentation"><a data-v-0044a876="" href="/a" class="btn btn-link" role="button">About</a></li></ul></div> <div data-v-0044a876="" class="toc-div"><ul data-v-d065e12c="" data-v-0044a876="" class="toc-ul"><li data-v-d065e12c=""><a data-v-d065e12c="" href="#"><b data-v-d065e12c="">åº”ç”¨ </b></a> <!----></li><li data-v-d065e12c=""><a data-v-d065e12c="" href="#-2"><b data-v-d065e12c="">çº§è”ä»£ç  </b></a> <!----></li><li data-v-d065e12c=""><a data-v-d065e12c="" href="#-3"><b data-v-d065e12c="">å¸¸ç”¨çš„ä¸­é—´ä»¶ </b></a> <!----></li><li data-v-d065e12c=""><a data-v-d065e12c="" href="#-4"><b data-v-d065e12c="">é”™è¯¯å¤„ç† </b></a> <!----></li><li data-v-d065e12c=""><a data-v-d065e12c="" href="#-5"><b data-v-d065e12c="">åº”ç”¨ä¸Šä¸‹æ–‡ </b></a> <!----></li></ul></div></div></aside> <section data-v-79039cdb="" class="page"><div data-v-79039cdb="" class="page-body"><button data-v-01aba251="" data-v-79039cdb="" type="button" class="navbar-toggle collapsed"><span data-v-01aba251="" class="sr-only">Toggle navigation</span> <span data-v-01aba251="" class="icon-bar"></span> <span data-v-01aba251="" class="icon-bar"></span> <span data-v-01aba251="" class="icon-bar"></span></button> <div data-v-79039cdb="" class="container-fluid"><div data-v-79039cdb="" class="row"><div data-v-79039cdb="" class="col-xs-12"><section data-v-f233b600="" data-v-79039cdb=""><h1 data-v-f233b600="">Koa Note</h1> <section data-v-f233b600="" id="post-content"><section data-v-19e352bd="" data-v-f233b600=""><div data-v-19e352bd="" class="meta-block"><i data-v-19e352bd="" class="glyphicon glyphicon-calendar"></i> <span data-v-19e352bd="">July 7, 2017</span></div> <div data-v-19e352bd="" class="meta-block"><a data-v-3cd447cb="" data-v-19e352bd="" href="/t#Koa" class="label-tag"><span data-v-3cd447cb="" class="label label-default">Koa</span></a><a data-v-3cd447cb="" data-v-19e352bd="" href="/t#NodeJs" class="label-tag"><span data-v-3cd447cb="" class="label label-success">NodeJs</span></a></div></section> <div data-v-f233b600=""><blockquote>
<p>Koaæ˜¯ä¸€ä¸ªç±»ä¼¼äº Express çš„ Web å¼€å‘æ¡†æ¶ï¼Œåˆ›å§‹äººä¹Ÿæ˜¯åŒä¸€ä¸ªäººã€‚å®ƒçš„ä¸»è¦ç‰¹ç‚¹æ˜¯ï¼Œä½¿ç”¨äº† ES6 çš„ Generator å‡½æ•°ï¼Œè¿›è¡Œäº†æ¶æ„çš„é‡æ–°è®¾è®¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒKoaçš„åŸç†å’Œå†…éƒ¨ç»“æ„å¾ˆåƒ Expressï¼Œä½†æ˜¯è¯­æ³•å’Œå†…éƒ¨ç»“æ„è¿›è¡Œäº†å‡çº§ã€‚</p>
<p>â€”â€” <cite>é˜®ä¸€å³°åšå®¢</cite></p>
</blockquote>
<p><strong>æƒ³è¦è¾¾åˆ°ä½¿ç”¨ Koa2 çš„å®Œæ•´ä½“éªŒï¼Œéœ€è¦å°† Node ç‰ˆæœ¬å‡çº§åˆ° v7.6+ ä»¥æ”¯æŒ async è¯­æ³•ã€‚</strong></p>
<p><strong>ä¸ºä»€ä¹ˆæ˜¯ Koa è€Œä¸æ˜¯ Express 4.0ï¼Ÿ</strong></p>
<p>å› ä¸º Generator å¸¦æ¥çš„æ”¹åŠ¨å¤ªå¤§äº†ï¼Œç›¸å½“äºæ¨å€’é‡æ¥ã€‚</p>
<p><strong>ä»¥ä¸‹å†…å®¹åŸºäº Koa2</strong></p>
<!--more-->
<h2 id="">åº”ç”¨ <a class="header-anchor" href="#" aria-hidden="true">ğŸ”—</a></h2>
<p>ä¸€ä¸ª Koa Applicationï¼ˆä»¥ä¸‹ç®€ç§° appï¼‰ç”±ä¸€ç³»åˆ— generator ä¸­é—´ä»¶ç»„æˆã€‚æŒ‰ç…§ç¼–ç é¡ºåºåœ¨æ ˆå†…ä¾æ¬¡æ‰§è¡Œï¼Œä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼ŒKoa app å’Œå…¶ä»–ä¸­é—´ä»¶ç³»ç»Ÿï¼ˆæ¯”å¦‚ Ruby Rack æˆ–è€… Connect / Express ï¼‰æ²¡æœ‰ä»€ä¹ˆå¤ªå¤§å·®åˆ«ã€‚</p>
<p>ç®€å•çš„ Hello World åº”ç”¨ç¨‹åº:</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> Koa = <span class="hljs-built_in">require</span>(<span class="hljs-string">'koa'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> Koa();

<span class="hljs-comment">// response</span>
app.use(<span class="hljs-function"><span class="hljs-params">ctx</span> =&gt;</span> {
  ctx.body = <span class="hljs-string">'Hello Koa'</span>;
});

app.listen(<span class="hljs-number">3000</span>);
</code></pre>
<h2 id="-2">çº§è”ä»£ç  <a class="header-anchor" href="#-2" aria-hidden="true">ğŸ”—</a></h2>
<p>Koa ä¸­é—´ä»¶ä»¥ä¸€ç§éå¸¸ä¼ ç»Ÿçš„æ–¹å¼çº§è”èµ·æ¥ã€‚</p>
<p>åœ¨ä»¥å¾€çš„ Node å¼€å‘ä¸­ï¼Œé¢‘ç¹ä½¿ç”¨å›è°ƒä¸å¤ªä¾¿äºå±•ç¤ºå¤æ‚çš„ä»£ç é€»è¾‘ï¼Œåœ¨ Koa ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å†™å‡ºçœŸæ­£å…·æœ‰è¡¨ç°åŠ›çš„ä¸­é—´ä»¶ã€‚ä¸ Connect å®ç°ä¸­é—´ä»¶çš„æ–¹æ³•ç›¸å¯¹æ¯”ï¼ŒKoa çš„åšæ³•ä¸æ˜¯ç®€å•çš„å°†æ§åˆ¶æƒä¾æ¬¡ç§»äº¤ç»™ä¸€ä¸ªåˆä¸€ä¸ªçš„ä¸­é—´ä»¶ç›´åˆ°ç¨‹åºç»“æŸï¼Œè€Œæœ‰ç‚¹åƒâ€œç©¿è¶Šä¸€åªæ´‹è‘±â€ã€‚</p>
<p><img src="https://camo.githubusercontent.com/d80cf3b511ef4898bcde9a464de491fa15a50d06/68747470733a2f2f7261772e6769746875622e636f6d2f66656e676d6b322f6b6f612d67756964652f6d61737465722f6f6e696f6e2e706e67" alt="å›¾ç¤º Koa ä¸­é—´ä»¶çº§è”"></p>
<p>ä¸‹è¾¹è¿™ä¸ªä¾‹å­å±•ç°äº†ä½¿ç”¨è¿™ä¸€ç‰¹æ®Šæ–¹æ³•ä¹¦å†™çš„ Hello World èŒƒä¾‹ã€‚</p>
<pre><code class="language-javascript"><span class="hljs-keyword">const</span> Koa = <span class="hljs-built_in">require</span>(<span class="hljs-string">'koa'</span>);
<span class="hljs-keyword">const</span> app = <span class="hljs-keyword">new</span> Koa();

<span class="hljs-comment">// x-response-time</span>
app.use(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-comment">// (1) è¿›å…¥è·¯ç”±</span>
  <span class="hljs-keyword">const</span> start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
  <span class="hljs-keyword">await</span> next();
  <span class="hljs-comment">// (5) å†æ¬¡è¿›å…¥ x-response-time ä¸­é—´ä»¶ï¼Œè®°å½•2æ¬¡é€šè¿‡æ­¤ä¸­é—´ä»¶ã€Œç©¿è¶Šã€çš„æ—¶é—´</span>
  <span class="hljs-keyword">const</span> ms = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() - start;
  <span class="hljs-comment">// (6) è¿”å› this.body</span>
  ctx.set(<span class="hljs-string">'X-Response-Time'</span>, <span class="hljs-string">`<span class="hljs-subst">${ms}</span>ms`</span>);
});

<span class="hljs-comment">// logger</span>
app.use(<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ctx, next</span>) </span>{
  <span class="hljs-comment">// (2) è¿›å…¥ logger ä¸­é—´ä»¶</span>
  <span class="hljs-keyword">const</span> start = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();
  <span class="hljs-keyword">await</span> next();
  <span class="hljs-comment">// (4) å†æ¬¡è¿›å…¥ logger ä¸­é—´ä»¶ï¼Œè®°å½•2æ¬¡é€šè¿‡æ­¤ä¸­é—´ä»¶ã€Œç©¿è¶Šã€çš„æ—¶é—´</span>
  <span class="hljs-keyword">const</span> ms = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>() - start;
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${ctx.method}</span> <span class="hljs-subst">${ctx.url}</span> - <span class="hljs-subst">${ms}</span>`</span>);
});

<span class="hljs-comment">// response</span>
app.use(<span class="hljs-function"><span class="hljs-params">ctx</span> =&gt;</span> {
  <span class="hljs-comment">// (3) è¿›å…¥ response ä¸­é—´ä»¶</span>
  ctx.body = <span class="hljs-string">'Hello World'</span>;
});

app.listen(<span class="hljs-number">3000</span>);
</code></pre>
<p>ä¹Ÿè®¸åˆšä» Express è¿‡æ¥çš„åŒå­¦ä¼šä¸€è„¸æ‡µé€¼ï¼Œå®é™…ä¸Šæˆ‘ä»¬å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆè¿™æ ·çš„ä¸€ä¸ªæµç¨‹ï¼ˆç±»ä¼¼ LESS ä»£ç ï¼‰ï¼š</p>
<pre><code class="language-less"><span class="hljs-selector-class">.x-response-time</span> {
  <span class="hljs-comment">// (1) do some stuff</span>
  <span class="hljs-selector-class">.logger</span> {
    <span class="hljs-comment">// (2) do some other stuff</span>
    <span class="hljs-selector-class">.response</span> {
      <span class="hljs-comment">// (3) NO next yield !</span>
      <span class="hljs-comment">// this.body = 'hello world'</span>
    }
    <span class="hljs-comment">// (4) do some other stuff later</span>
  }
  <span class="hljs-comment">// (5) do some stuff lastest and return</span>
}
</code></pre>
<p>è¿™ä¾¿æ˜¯ Koa ä¸­é—´ä»¶çš„ä¸€å¤§ç‰¹è‰²äº†ã€‚å¦ä¸€ç‚¹ä¹Ÿèƒ½åœ¨ä¾‹å­ä¸­æ‰¾åˆ°ï¼šå³ Koa æ”¯æŒ <code>async</code> ä»¥åŠ <code>await</code> è¯­æ³•ï¼Œå¯ä»¥åœ¨ä¸­é—´ä»¶ä¸­è¿›è¡Œä»»æ„æ–¹å¼çš„ä½¿ç”¨ï¼ˆæ¯”å¦‚ await mongoose æ“ä½œï¼‰ï¼Œè¿™æ ·å¯¹æ¯”èµ·æ¥ Express å…¶ä¼˜ç‚¹å°±ååˆ†æ˜æ˜¾äº†ã€‚</p>
<h2 id="-3">å¸¸ç”¨çš„ä¸­é—´ä»¶ <a class="header-anchor" href="#-3" aria-hidden="true">ğŸ”—</a></h2>
<ul>
<li><a href="https://www.npmjs.com/package/koa-bodyparser">koa-bodyparser</a></li>
<li><a href="https://www.npmjs.com/package/koa-favicon">koa-favicon</a></li>
<li><a href="https://www.npmjs.com/package/koa-helmet">koa-helmet</a></li>
<li><a href="https://www.npmjs.com/package/koa-lusca">koa-lusca</a></li>
<li><a href="https://www.npmjs.com/package/koa-morgan">koa-morgan</a></li>
<li><a href="https://www.npmjs.com/package/koa-multer">koa-multer</a></li>
<li><a href="https://www.npmjs.com/package/koa-passport">koa-passport</a></li>
<li><a href="https://www.npmjs.com/package/koa-router">koa-router</a></li>
<li><a href="https://www.npmjs.com/package/koa-session">koa-session</a></li>
<li><a href="https://www.npmjs.com/package/koa-static-cache">koa-static-cache</a></li>
</ul>
<p>ï¼ˆç­‰ç­‰ï¼‰</p>
<h2 id="-4">é”™è¯¯å¤„ç† <a class="header-anchor" href="#-4" aria-hidden="true">ğŸ”—</a></h2>
<p>é™¤é <code>app.silent</code> è¢«è®¾ç½®ä¸º <code>true</code>ï¼Œå¦åˆ™æ‰€æœ‰ error éƒ½ä¼šè¢«è¾“å‡ºåˆ° <code>stderr</code>ï¼Œå¹¶ä¸”é»˜è®¤çš„ error handler ä¸ä¼šè¾“å‡º <code>err.status === 404 || err.expose === true</code> çš„é”™è¯¯ã€‚å¯ä»¥è‡ªå®šä¹‰ã€Œé”™è¯¯äº‹ä»¶ã€æ¥ç›‘å¬ Koa app ä¸­å‘ç”Ÿçš„é”™è¯¯ï¼Œæ¯”å¦‚ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼šè®°å½•é”™è¯¯æ—¥å¿—</p>
<pre><code class="language-javascript">app.on(<span class="hljs-string">'error'</span>, err =&gt;
  log.error(<span class="hljs-string">'server error'</span>, err)
);
</code></pre>
<h2 id="-5">åº”ç”¨ä¸Šä¸‹æ–‡ <a class="header-anchor" href="#-5" aria-hidden="true">ğŸ”—</a></h2>
<p>Koa çš„ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰å°† request ä¸ response å¯¹è±¡å°è£…è‡³ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œå¹¶æä¾›äº†ä¸€äº›å¸®åŠ©å¼€å‘è€…ç¼–å†™ä¸šåŠ¡é€»è¾‘çš„æ–¹æ³•ã€‚</p>
<p>æ¯ä¸ª request ä¼šåˆ›å»ºä¸€ä¸ª Contextï¼Œå¹¶ä¸”å‘ä¸­é—´ä»¶ä¸­ä¼ å¼•ç”¨å€¼ã€‚</p>
<pre><code class="language-javascript">app.use(<span class="hljs-keyword">async</span> (ctx, next) =&gt; {
  ctx; <span class="hljs-comment">// is the Context</span>
  ctx.request; <span class="hljs-comment">// is a koa Request</span>
  ctx.response; <span class="hljs-comment">// is a koa Response</span>
});
</code></pre>
<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒæŒ‚è½½åœ¨ Context å¯¹è±¡ä¸Šçš„å¹¶ä¸æ˜¯ Node.js åŸç”Ÿçš„ Response å’Œ Request å¯¹è±¡ï¼Œè€Œæ˜¯ç»è¿‡ Koa å°è£…è¿‡çš„ã€‚Koa æä¾›å¦å¤–çš„æ–¹æ³•æ¥è®¿é—®åŸç”Ÿå¯¹è±¡ï¼Œä½†æ˜¯å¹¶ä¸å»ºè®®è¿™ä¹ˆåšï¼</strong></p>
<p>ä¸ºäº†ä½¿ç”¨æ–¹ä¾¿ï¼Œè®¸å¤šä¸Šä¸‹æ–‡å±æ€§å’Œæ–¹æ³•éƒ½è¢«å§”æ‰˜ä»£ç†åˆ°ä»–ä»¬çš„ <code>ctx.request</code> æˆ– <code>ctx.response</code>ï¼Œæ¯”å¦‚è®¿é—® <code>ctx.type</code> å’Œ <code>ctx.length</code> å°†è¢«ä»£ç†åˆ° <code>response</code> å¯¹è±¡ï¼Œ<code>ctx.path</code> å’Œ <code>ctx.method</code> å°†è¢«ä»£ç†åˆ° <code>request</code> å¯¹è±¡ã€‚</p>
</div> <hr data-v-f233b600=""> <nav data-v-7144c3e4="" data-v-f233b600=""><ul data-v-7144c3e4="" class="pager"><li data-v-7144c3e4="" class="previous"><a data-v-7144c3e4="" href="/p/vue-components-i18n" class=""><i data-v-7144c3e4="" class="glyphicon glyphicon-chevron-left"></i> ä¸º Vue ç»„ä»¶åº“å®ç°å›½é™…åŒ–æ”¯æŒ
      </a></li> <li data-v-7144c3e4="" class="next"><a data-v-7144c3e4="" href="/p/holiday-soon-finally" class="">
        ç»ˆäºè¦æ”¾å‡äº† <i data-v-7144c3e4="" class="glyphicon glyphicon-chevron-right"></i></a></li></ul></nav> <hr data-v-f233b600=""> <div data-v-1a6fe007="" data-v-f233b600="" id="disqus_thread"><i data-v-1a6fe007="" class="glyphicon glyphicon-refresh icon-spin"></i> <span data-v-1a6fe007="">Loading Disqus......</span></div></section></section></div></div></div></div> <section data-v-f9dc3034="" data-v-79039cdb="" class="page-footer"><div data-v-f9dc3034="" class="container-fluid"><div data-v-f9dc3034="" class="row"><div data-v-f9dc3034="" class="col-xs-12"><p data-v-f9dc3034=""><span data-v-f9dc3034="">Links:</span> <!----> <a data-v-f9dc3034="" href="https://blog.aquariuslt.com/" target="_blank">Aquariuslt</a><span data-v-f9dc3034="">&nbsp;/</span> <a data-v-f9dc3034="" href="https://lz5z.com" target="_blank">Leo's Blog</a></p></div></div> <div data-v-f9dc3034="" class="row"><div data-v-f9dc3034="" class="col-xs-12"><a data-v-f9dc3034="" href="https://wxsm.space">Â© 2018 WXSM</a> <span data-v-f9dc3034="">/</span> <a data-v-f9dc3034="" href="/feed.xml" rel="nofollow" target="_blank">FEED</a> <span data-v-f9dc3034="">/</span> <a data-v-f9dc3034="" title="LICENSE" href="https://creativecommons.org/licenses/by/4.0/" rel="nofollow">CC BY 4.0</a></div></div></div></section></section></section>
<div id="nprogress" style="transition: none; -webkit-transition: none; opacity: 1;"><div class="bar" role="bar" style="transition: all 200ms ease; -webkit-transition: all 200ms ease; -webkit-transform: translate3d(0%, 0px, 0px);"><div class="peg"></div></div></div></body></html>
